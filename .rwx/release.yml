on:
  github:
    push:
      if: ${{ starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        tag: ${{ event.git.tag }}
      status-checks:
        name: Release
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      tag: dev

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: system-deps
    run: |
      sudo apt-get update
      sudo apt-get install -y protobuf-compiler libssl-dev gcc-aarch64-linux-gnu

  - key: code
    use: system-deps
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/coop.git
      ref: ${{ init.commit-sha }}

  - key: rust
    use: code
    run: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      . "$HOME/.cargo/env"
      rustup target add x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu \
        x86_64-apple-darwin aarch64-apple-darwin
      echo "$HOME/.cargo/bin" >> $RWX_ENV/PATH
      echo "" | tee $RWX_ENV/RUSTC_WRAPPER

  # Zig is used as a C/C++ cross-linker for macOS targets from Linux
  - key: zig
    use: rust
    run: |
      mkdir -p "$HOME/.local/zig"
      curl -sSfL https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz \
        | tar xJ -C "$HOME/.local/zig"
      echo "$HOME/.local/zig/zig-linux-x86_64-0.13.0" >> $RWX_ENV/PATH
      # Install cargo-zigbuild for seamless Rust + Zig cross-compilation
      cargo install cargo-zigbuild

  - key: set-version
    use: rust
    run: |
      VERSION="${TAG#v}"
      if [ "$VERSION" = "dev" ]; then
        VERSION="0.1.0"
      fi
      echo "Setting workspace version to $VERSION"
      tmp=$(mktemp)
      sed "s/^version = \"0.1.0\"/version = \"$VERSION\"/" Cargo.toml > "$tmp"
      mv "$tmp" Cargo.toml
    env:
      TAG: ${{ init.tag }}

  # Parallel builds for all targets
  - key: build-linux-amd64
    use: set-version
    run: |
      cargo build --release --target x86_64-unknown-linux-gnu
      strip target/x86_64-unknown-linux-gnu/release/coop 2>/dev/null || true
      strip target/x86_64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/x86_64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-amd64.tar.gz coop coop-mux

  - key: build-linux-arm64
    use: set-version
    run: |
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc \
        cargo build --release --target aarch64-unknown-linux-gnu
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coop 2>/dev/null || true
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/aarch64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-arm64.tar.gz coop coop-mux

  - key: build-darwin-amd64
    use: [set-version, zig]
    run: |
      cargo zigbuild --release --target x86_64-apple-darwin
      cd target/x86_64-apple-darwin/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-darwin-amd64.tar.gz coop coop-mux

  - key: build-darwin-arm64
    use: [set-version, zig]
    run: |
      cargo zigbuild --release --target aarch64-apple-darwin
      cd target/aarch64-apple-darwin/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-darwin-arm64.tar.gz coop coop-mux

  - key: release
    use: [build-linux-amd64, build-linux-arm64]
    if: ${{ init.tag != 'dev' }}
    run: |
      # Install gh CLI
      curl -sSfL https://github.com/cli/cli/releases/download/v2.65.0/gh_2.65.0_linux_amd64.tar.gz \
        | tar xz -C /tmp
      sudo cp /tmp/gh_2.65.0_linux_amd64/bin/gh /usr/local/bin/

      # Create checksums
      cd /tmp
      sha256sum coop-linux-amd64.tar.gz coop-linux-arm64.tar.gz > checksums.txt

      # Create GitHub release (Darwin builds temporarily skipped â€” aws-lc-sys cross-compile issue)
      gh release create "$TAG" \
        --repo groblegark/coop \
        --title "$TAG" \
        --generate-notes \
        coop-linux-amd64.tar.gz \
        coop-linux-arm64.tar.gz \
        checksums.txt
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      TAG: ${{ init.tag }}

  - key: dispatch-gastown
    use: release
    run: |
      # Trigger gastown agent image rebuild via RWX dispatch API
      DISPATCH_ID=$(curl -sSf -X POST https://cloud.rwx.com/mint/api/runs/dispatches \
        -H "Authorization: Bearer $RWX_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"key\": \"gastown-agent-rebuild\", \"params\": {\"trigger-source\": \"coop-release-$TAG\", \"coop-version\": \"$TAG\"}, \"ref\": \"main\", \"title\": \"Agent rebuild (coop $TAG)\"}" \
        | python3 -c "import sys,json; print(json.load(sys.stdin).get('dispatch_id',''))")
      echo "Dispatched gastown-agent-rebuild via RWX (dispatch_id=$DISPATCH_ID, tag=$TAG)"
    env:
      RWX_TOKEN: ${{ secrets.RWX_ACCESS_TOKEN }}
      TAG: ${{ init.tag }}
