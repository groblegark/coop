on:
  github:
    push:
      if: ${{ starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        tag: ${{ event.git.tag }}
      status-checks:
        name: Release
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      tag: dev

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: system-deps
    run: |
      sudo apt-get update
      sudo apt-get install -y protobuf-compiler libssl-dev gcc-aarch64-linux-gnu

  - key: code
    use: system-deps
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/coop.git
      ref: ${{ init.commit-sha }}

  - key: rust
    use: code
    run: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      . "$HOME/.cargo/env"
      rustup target add x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu
      echo "$HOME/.cargo/bin" >> $RWX_ENV/PATH
      echo "" | tee $RWX_ENV/RUSTC_WRAPPER

  - key: set-version
    use: rust
    run: |
      VERSION="${TAG#v}"
      if [ "$VERSION" = "dev" ]; then
        VERSION="0.1.0"
      fi
      echo "Setting workspace version to $VERSION"
      tmp=$(mktemp)
      sed "s/^version = \"0.1.0\"/version = \"$VERSION\"/" Cargo.toml > "$tmp"
      mv "$tmp" Cargo.toml
    env:
      TAG: ${{ init.tag }}

  # Parallel builds for linux amd64 and arm64
  - key: build-linux-amd64
    use: set-version
    run: |
      cargo build --release --target x86_64-unknown-linux-gnu
      strip target/x86_64-unknown-linux-gnu/release/coop 2>/dev/null || true
      strip target/x86_64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/x86_64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-amd64.tar.gz coop coop-mux

  - key: build-linux-arm64
    use: set-version
    run: |
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc \
        cargo build --release --target aarch64-unknown-linux-gnu
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coop 2>/dev/null || true
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/aarch64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-arm64.tar.gz coop coop-mux

  - key: release
    use: [build-linux-amd64, build-linux-arm64]
    if: ${{ init.tag != 'dev' }}
    run: |
      # Install gh CLI
      curl -sSfL https://github.com/cli/cli/releases/download/v2.65.0/gh_2.65.0_linux_amd64.tar.gz \
        | tar xz -C /tmp
      sudo cp /tmp/gh_2.65.0_linux_amd64/bin/gh /usr/local/bin/

      # Create checksums
      cd /tmp
      sha256sum coop-linux-amd64.tar.gz coop-linux-arm64.tar.gz > checksums.txt

      # Create GitHub release
      gh release create "$TAG" \
        --repo groblegark/coop \
        --title "$TAG" \
        --generate-notes \
        coop-linux-amd64.tar.gz \
        coop-linux-arm64.tar.gz \
        checksums.txt
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      TAG: ${{ init.tag }}

  - key: dispatch-gastown
    use: release
    run: |
      # Trigger gastown agent image rebuild
      curl -X POST \
        -H "Authorization: token $DISPATCH_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/groblegark/gastown/dispatches" \
        -d "{\"event_type\":\"coop-release\",\"client_payload\":{\"tag\":\"$TAG\"}}"
      echo "Dispatched coop-release to gastown with tag $TAG"
    env:
      DISPATCH_TOKEN: ${{ secrets.DISPATCH_PAT }}
      TAG: ${{ init.tag }}
