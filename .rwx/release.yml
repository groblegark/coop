on:
  github:
    push:
      if: ${{ starts-with(event.git.tag, '20') }}
      init:
        commit-sha: ${{ event.git.sha }}
        tag: ${{ event.git.tag }}
      status-checks:
        name: Release
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      tag: dev

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tool-cache:
  vault: default

tasks:
  - key: system-deps
    filter:
      - .rwx/release.yml
    run: |
      sudo apt-get update
      sudo apt-get install -y protobuf-compiler libssl-dev gcc-aarch64-linux-gnu

  # ── Clone (parallel with system-deps) ─────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/coop.git
      ref: ${{ init.commit-sha }}

  - key: rust
    use: [code, system-deps]
    filter:
      - .rwx/release.yml
    run: |
      curl --proto '=https' --tlsv1.2 -fsSL https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.93.0
      . "$HOME/.cargo/env"
      rustup target add x86_64-unknown-linux-gnu aarch64-unknown-linux-gnu x86_64-apple-darwin aarch64-apple-darwin
      cargo install cargo-zigbuild
      echo "$HOME/.cargo/bin" >> $RWX_ENV/PATH
      echo "" | tee $RWX_ENV/RUSTC_WRAPPER

  # ── Zig cross-compiler for darwin builds ──────────────────────────────
  - key: zig
    filter:
      - .rwx/release.yml
    run: |
      curl -fsSL "https://ziglang.org/download/0.14.0/zig-linux-x86_64-0.14.0.tar.xz" \
        | tar -xJ -C /tmp
      sudo ln -sf /tmp/zig-linux-x86_64-0.14.0/zig /usr/local/bin/zig
      zig version

  - key: set-version
    use: rust
    run: |
      VERSION="${TAG#v}"
      if [ "$VERSION" = "dev" ]; then
        VERSION="0.1.0"
      else
        # CalVer tags are already 3-part semver-compatible (YYYY.MDD.N).
        # Legacy 4-part tags (YYYY.MM.DD.N) are converted to YYYY.MDD.N for Cargo.toml.
        if [[ "$VERSION" =~ ^([0-9]{4})\.0?([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}${BASH_REMATCH[3]}.${BASH_REMATCH[4]}"
          echo "Converted legacy 4-part CalVer to semver: $VERSION"
        fi
      fi
      echo "Setting workspace version to $VERSION"
      tmp=$(mktemp)
      sed "s/^version = \"[0-9][0-9.]*\"/version = \"$VERSION\"/" Cargo.toml > "$tmp"
      mv "$tmp" Cargo.toml
    env:
      TAG: ${{ init.tag }}

  # Parallel builds for all targets
  - key: build-linux-amd64
    use: set-version
    agent:
      cpus: 8
    tool-cache: release-linux-amd64
    run: |
      cargo build --release --target x86_64-unknown-linux-gnu
      strip target/x86_64-unknown-linux-gnu/release/coop 2>/dev/null || true
      strip target/x86_64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/x86_64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-amd64.tar.gz coop coop-mux

  - key: build-linux-arm64
    use: set-version
    agent:
      cpus: 8
    tool-cache: release-linux-arm64
    run: |
      CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc \
        cargo build --release --target aarch64-unknown-linux-gnu
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coop 2>/dev/null || true
      aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/coopmux 2>/dev/null || true
      cd target/aarch64-unknown-linux-gnu/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-linux-arm64.tar.gz coop coop-mux

  - key: build-darwin-amd64
    use: [set-version, zig]
    agent:
      cpus: 8
    tool-cache: release-darwin-amd64
    run: |
      cargo zigbuild --release --target x86_64-apple-darwin
      cd target/x86_64-apple-darwin/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-darwin-amd64.tar.gz coop coop-mux

  - key: build-darwin-arm64
    use: [set-version, zig]
    agent:
      cpus: 8
    tool-cache: release-darwin-arm64
    run: |
      cargo zigbuild --release --target aarch64-apple-darwin
      cd target/aarch64-apple-darwin/release
      cp coopmux coop-mux 2>/dev/null || true
      tar czf /tmp/coop-darwin-arm64.tar.gz coop coop-mux

  - key: release
    use: [build-linux-amd64, build-linux-arm64]
    if: ${{ init.tag != 'dev' }}
    run: |
      # Install gh CLI
      curl -fsSL https://github.com/cli/cli/releases/download/v2.65.0/gh_2.65.0_linux_amd64.tar.gz \
        | tar xz -C /tmp
      sudo cp /tmp/gh_2.65.0_linux_amd64/bin/gh /usr/local/bin/

      # Create checksums
      cd /tmp
      sha256sum coop-linux-amd64.tar.gz coop-linux-arm64.tar.gz > checksums.txt

      # Create GitHub release (linux only — darwin cross-compile is broken
      # due to ring/Security framework linking; macOS builds are local-only)
      gh release create "$TAG" \
        --repo groblegark/coop \
        --title "$TAG" \
        --generate-notes \
        coop-linux-amd64.tar.gz \
        coop-linux-arm64.tar.gz \
        checksums.txt
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      TAG: ${{ init.tag }}

  - key: dispatch-gastown
    use: release
    run: |
      # Trigger gastown agent image rebuild via RWX dispatch API
      DISPATCH_ID=$(curl -fsSL -X POST https://cloud.rwx.com/mint/api/runs/dispatches \
        -H "Authorization: Bearer $RWX_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"key\": \"gastown-agent-rebuild\", \"params\": {\"trigger-source\": \"coop-release-$TAG\", \"coop-version\": \"$TAG\"}, \"ref\": \"main\", \"title\": \"Agent rebuild (coop $TAG)\"}" \
        | python3 -c "import sys,json; print(json.load(sys.stdin).get('dispatch_id',''))")
      echo "Dispatched gastown-agent-rebuild via RWX (dispatch_id=$DISPATCH_ID, tag=$TAG)"
    env:
      RWX_TOKEN: ${{ secrets.RWX_ACCESS_TOKEN }}
      TAG: ${{ init.tag }}

  - key: dispatch-gasboat
    use: release
    run: |
      # Trigger gasboat agent image rebuild via RWX dispatch API
      echo "Dispatching to gasboat for agent rebuild (coop: $TAG)..."
      curl -fsSL -X POST https://cloud.rwx.com/mint/api/runs/dispatches \
        -H "Authorization: Bearer $RWX_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{\"key\": \"gasboat-agent-rebuild\", \"params\": {\"trigger-source\": \"coop-release-$TAG\", \"coop-version\": \"$TAG\"}, \"ref\": \"main\", \"title\": \"Agent rebuild (coop $TAG)\"}"
    env:
      RWX_TOKEN: ${{ secrets.RWX_ACCESS_TOKEN }}
      TAG: ${{ init.tag }}
