# Push OCI images to GHCR via rwx image push.
# Called by docker.yml via embedded run (uses rwx/base for CLI access).

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: rwx-cli
    call: rwx/install-cli 4.0.1

  # ── GHCR auth ─────────────────────────────────────────────────────────
  - key: ghcr-auth
    use: rwx-cli
    run: |
      mkdir -p ~/.docker
      AUTH=$(printf '%s:%s' "$GITHUB_USER" "$GHCR_TOKEN" | base64 -w0)
      printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "$AUTH" > ~/.docker/config.json
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── push-claude ───────────────────────────────────────────────────────
  - key: push-claude
    use: ghcr-auth
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:claude-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:claude

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:claude-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ init.image-claude-task-id }}

  # ── push-coopmux ─────────────────────────────────────────────────────
  - key: push-coopmux
    use: ghcr-auth
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:coopmux-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:coopmux

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:coopmux-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ init.image-coopmux-task-id }}
