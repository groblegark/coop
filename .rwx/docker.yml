# OCI image build for coop (empty, claude, gemini variants)
# Build uses rwx/base (for toolchain), image assembly uses config: none
# (for clean OCI output), connected via embedded runs (call:).
# Push to GHCR via rwx image push — no Docker daemon needed.

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
      status-checks:
        name: Docker
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
      status-checks:
        - tasks: [build]
          name: Docker
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tool-cache:
  vault: default

tasks:
  # ═══════════════════════════════════════════════════════════════════════
  # Build — native Rust compile via embedded run (rwx/base for toolchain)
  # ═══════════════════════════════════════════════════════════════════════
  - key: build
    call: ${{ run.dir }}/build.yml
    init:
      commit-sha: ${{ init.commit-sha }}

  # ═══════════════════════════════════════════════════════════════════════
  # Image assembly — embedded run with config: none for clean OCI output
  # ═══════════════════════════════════════════════════════════════════════
  - key: images
    call: ${{ run.dir }}/image.yml
    after: build
    init:
      coop-binary-path: ${{ tasks.build.tasks.build-coop.artifacts.coop-binary }}

  # ═══════════════════════════════════════════════════════════════════════
  # Push — rwx image push to GHCR (skipped on PRs)
  # ═══════════════════════════════════════════════════════════════════════

  - key: rwx-cli
    after: images
    if: ${{ init.ref-name != 'pr' }}
    call: rwx/install-cli 4.0.1

  # ── GHCR auth (write Docker credential file for rwx image push) ──────
  - key: ghcr-auth
    use: rwx-cli
    if: ${{ init.ref-name != 'pr' }}
    run: |
      mkdir -p ~/.docker
      AUTH=$(printf '%s:%s' "$GITHUB_USER" "$GHCR_TOKEN" | base64 -w0)
      printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "$AUTH" > ~/.docker/config.json
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── push-empty ────────────────────────────────────────────────────────
  - key: push-empty
    use: ghcr-auth
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:empty-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:empty

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:empty-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.images.tasks.image-empty.id }}

  # ── push-claude ───────────────────────────────────────────────────────
  - key: push-claude
    use: ghcr-auth
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:claude-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:claude

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:claude-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.images.tasks.image-claude.id }}

  # ── push-gemini ───────────────────────────────────────────────────────
  - key: push-gemini
    use: ghcr-auth
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:gemini-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:gemini

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:gemini-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.images.tasks.image-gemini.id }}
