# OCI image build for coop (empty, claude, gemini variants)
# Single workflow with config: none for clean OCI output.
# Build tasks install toolchain manually; image tasks start from clean
# base (no use:) for proper layer isolation. Push via rwx image push.

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
      status-checks:
        name: Docker
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
      status-checks:
        - tasks: [build-coop]
          name: Docker
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli

base:
  image: ubuntu:24.04
  config: none

tasks:
  # ═══════════════════════════════════════════════════════════════════════
  # Build — native Rust compile, outputs binary artifact
  # ═══════════════════════════════════════════════════════════════════════

  # ── System deps (protobuf compiler for tonic) ──────────────────────────
  - key: build-deps
    filter:
      - .rwx/docker.yml
    run: |
      apt-get update
      apt-get install -y git protobuf-compiler curl build-essential pkg-config libssl-dev

  # ── Clone (parallel with build-deps) ──────────────────────────────────
  - key: code
    use: build-deps
    run: |
      git init
      git remote add origin https://github.com/groblegark/coop.git
      git fetch --depth 1 origin "$COMMIT_SHA"
      git checkout FETCH_HEAD
    env:
      COMMIT_SHA: ${{ init.commit-sha }}

  # ── Rust toolchain ─────────────────────────────────────────────────────
  - key: rust
    use: build-deps
    filter:
      - .rwx/docker.yml
    run: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
        | sh -s -- -y --default-toolchain stable
      echo "$HOME/.cargo/bin" | tee -a $RWX_ENV/PATH
      echo "" | tee $RWX_ENV/RUSTC_WRAPPER

  # ── Cargo fetch ────────────────────────────────────────────────────────
  - key: cargo-deps
    use: [code, rust]
    run: cargo fetch

  # ── Build coop binary → artifact ──────────────────────────────────────
  - key: build-coop
    use: cargo-deps
    agent:
      cpus: 8
    run: |
      cargo build --release -p coop
      cp target/release/coop coop-bin
    outputs:
      artifacts:
        - key: coop-binary
          path: coop-bin

  # ═══════════════════════════════════════════════════════════════════════
  # Image assembly — no use: = clean filesystem (multi-stage equivalent)
  # Each task starts fresh from base image and installs only runtime deps.
  # Artifact references work within the same run regardless of use: chain.
  # ═══════════════════════════════════════════════════════════════════════

  # ── image-empty: coop + common dev tools ─────────────────────────────
  - key: image-empty
    after: build-coop
    run: |
      apt-get update && apt-get install -y --no-install-recommends \
        git python3 build-essential openssh-client \
        jq ripgrep fd-find tree \
        ca-certificates curl \
        && rm -rf /var/lib/apt/lists/*
      cp ${{ tasks.build-coop.artifacts.coop-binary }} /coop
      chmod +x /coop
      jq -n '["/coop"]' > $RWX_IMAGE/entrypoint.json

  # ── image-claude: coop + Claude CLI ──────────────────────────────────
  - key: image-claude
    after: build-coop
    run: |
      apt-get update && apt-get install -y --no-install-recommends \
        git python3 build-essential openssh-client \
        jq ripgrep fd-find tree \
        ca-certificates curl \
        && rm -rf /var/lib/apt/lists/*
      curl -fsSL https://claude.ai/install.sh | bash
      cp ${{ tasks.build-coop.artifacts.coop-binary }} /usr/local/bin/coop
      chmod +x /usr/local/bin/coop
      jq -n '["coop"]' > $RWX_IMAGE/entrypoint.json
    env:
      PATH: /root/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

  # ── image-gemini: coop + Gemini CLI + Node.js ────────────────────────
  - key: image-gemini
    after: build-coop
    run: |
      apt-get update && apt-get install -y --no-install-recommends \
        git python3 build-essential openssh-client \
        jq ripgrep fd-find tree \
        ca-certificates curl nodejs npm \
        && rm -rf /var/lib/apt/lists/*
      npm install -g @google/gemini-cli
      ln -sf ../lib/node_modules/@google/gemini-cli/dist/src/cli.js /usr/local/bin/gemini
      cp ${{ tasks.build-coop.artifacts.coop-binary }} /usr/local/bin/coop
      chmod +x /usr/local/bin/coop
      jq -n '["coop"]' > $RWX_IMAGE/entrypoint.json

  # ═══════════════════════════════════════════════════════════════════════
  # Push — rwx image push to GHCR (skipped on PRs)
  # Install rwx CLI manually since config: none has no packages.
  # ═══════════════════════════════════════════════════════════════════════

  - key: push-deps
    after: [image-empty, image-claude, image-gemini]
    if: ${{ init.ref-name != 'pr' }}
    run: |
      apt-get update && apt-get install -y --no-install-recommends ca-certificates curl
      curl -fsSL https://install.rwx.com/rwx -o /tmp/install-rwx
      bash /tmp/install-rwx
      rm /tmp/install-rwx
      echo "$HOME/.rwx/bin" | tee -a $RWX_ENV/PATH
      mkdir -p ~/.docker
      AUTH=$(printf '%s:%s' "$GITHUB_USER" "$GHCR_TOKEN" | base64 -w0)
      printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "$AUTH" > ~/.docker/config.json
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  # ── push-empty ────────────────────────────────────────────────────────
  - key: push-empty
    use: push-deps
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:empty-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:empty

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:empty-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.image-empty.id }}

  # ── push-claude ───────────────────────────────────────────────────────
  - key: push-claude
    use: push-deps
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:claude-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:claude

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:claude-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.image-claude.id }}

  # ── push-gemini ───────────────────────────────────────────────────────
  - key: push-gemini
    use: push-deps
    if: ${{ init.ref-name != 'pr' }}
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"; REF_NAME="${REF_NAME#refs/heads/}"
      SHORT_SHA="${COMMIT_SHA:0:7}"

      rwx image push $IMAGE_TASK_ID \
        --to ghcr.io/groblegark/coop:gemini-sha-${SHORT_SHA} \
        --to ghcr.io/groblegark/coop:gemini

      if [[ "$REF_NAME" == v* ]]; then
        VERSION="${REF_NAME#v}"
        rwx image push $IMAGE_TASK_ID --to ghcr.io/groblegark/coop:gemini-${VERSION}
      fi
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
      IMAGE_TASK_ID: ${{ tasks.image-gemini.id }}
