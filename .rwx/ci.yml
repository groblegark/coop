on:
  github:
    push:
      if: ${{ event.git.branch == 'main' }}
      init:
        commit-sha: ${{ event.git.sha }}
      status-checks:
        name: CI
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
      status-checks:
        - tasks: [fmt, clippy, test-linux, smoke-test]
          name: CI
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tool-cache:
  vault: coop_main

tasks:
  # ── System deps ────────────────────────────────────────────────────────
  - key: system-deps
    filter:
      - .rwx/ci.yml
    run: |
      sudo apt-get update
      sudo apt-get install -y protobuf-compiler tmux curl pkg-config libssl-dev

  # ── Clone (parallel with system-deps) ─────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/coop.git
      ref: ${{ init.commit-sha }}

  # ── Rust toolchain (cached across workflow runs) ──────────────────────
  - key: rust
    use: [code, system-deps]
    filter:
      - .rwx/ci.yml
    run: |
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
      . "$HOME/.cargo/env"
      rustup component add rustfmt clippy
      echo "$HOME/.cargo/bin" | tee -a $RWX_ENV/PATH
      # Disable sccache wrapper (set by rwx/base) — we use RWX content caching instead
      echo "" | tee $RWX_ENV/RUSTC_WRAPPER

  # ── Cargo fetch ────────────────────────────────────────────────────────
  - key: cargo-deps
    use: rust
    run: cargo fetch

  # ── Format check (parallel) ──────────────────────────────────────────
  - key: fmt
    use: cargo-deps
    run: cargo fmt --all -- --check

  # ── Clippy (parallel with fmt, tests, smoke-test) ──────────────────────
  - key: clippy
    use: cargo-deps
    agent:
      cpus: 8
    tool-cache: ci-clippy
    run: cargo clippy --all -- -D warnings

  # ── Install cargo-audit (cached) ───────────────────────────────────────
  - key: install-audit
    use: rust
    filter:
      - .rwx/ci.yml
    run: cargo install cargo-audit

  # ── Install cargo-deny (cached) ───────────────────────────────────────
  - key: install-deny
    use: rust
    filter:
      - .rwx/ci.yml
    run: cargo install cargo-deny

  # ── Audit (parallel) ─────────────────────────────────────────────────
  - key: audit
    use: [cargo-deps, install-audit]
    run: cargo audit

  # ── Deny (parallel) ──────────────────────────────────────────────────
  - key: deny
    use: [cargo-deps, install-deny]
    run: cargo deny check licenses bans sources

  # ── Tests (parallel with clippy) ─────────────────────────────────────
  - key: test-linux
    use: cargo-deps
    agent:
      cpus: 8
    tool-cache: ci-test
    run: cargo test --all --lib --bins

  # ── Smoke test (native binary, no Docker needed) ────────────────────
  - key: smoke-test
    use: cargo-deps
    tool-cache: ci-smoke
    run: |
      cargo build -p coop
      ./target/debug/coop --help
