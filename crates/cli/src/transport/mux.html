<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coop Multiplexer</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; background: #1e1e1e; overflow: hidden; font-family: Menlo, Monaco, monospace; }

  /* Header bar */
  #header {
    height: 32px; line-height: 32px; padding: 0 12px;
    background: #111; border-bottom: 1px solid #333;
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; color: #aaa;
  }
  #header .stats { display: flex; gap: 16px; }
  .stat-label { color: #666; }
  .stat-value { color: #ccc; font-weight: 600; }
  .stat-value.healthy { color: #4ec950; }
  .stat-value.alert { color: #e06060; }

  /* Grid of pod tiles */
  #grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 4px;
    padding: 4px;
    height: calc(100% - 32px - 24px);
    overflow-y: auto;
  }

  /* Pod tile */
  .pod-tile {
    background: #181818;
    border: 1px solid #333;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    min-height: 200px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .pod-tile:hover { border-color: #555; }
  .pod-tile.focused { border-color: #7cb7ff; }
  .pod-tile.expanded {
    position: fixed; top: 32px; left: 0; right: 0; bottom: 24px;
    z-index: 50; border-radius: 0; border-color: #7cb7ff;
    min-height: auto;
  }

  /* Tile header */
  .pod-header {
    display: flex; align-items: center; gap: 8px;
    padding: 4px 8px; background: #151515;
    border-bottom: 1px solid #2a2a2a;
    font-size: 11px; flex-shrink: 0;
  }
  .pod-name { font-weight: 600; color: #ccc; }
  .pod-badge {
    font-size: 10px; padding: 1px 6px;
    border-radius: 3px; border: 1px solid;
    font-weight: 600;
  }
  .pod-badge.working { border-color: #4e8; color: #4e8; }
  .pod-badge.idle { border-color: #e8a317; color: #e8a317; }
  .pod-badge.prompt { border-color: #7cb7ff; color: #7cb7ff; }
  .pod-badge.error { border-color: #e06060; color: #e06060; }
  .pod-badge.exited { border-color: #888; color: #888; }
  .pod-badge.starting { border-color: #b8a0e8; color: #b8a0e8; }
  .pod-badge.offline { border-color: #555; color: #555; }
  .cred-indicator {
    font-size: 10px; margin-left: auto; color: #666;
  }
  .cred-indicator.alert { color: #e06060; font-weight: 600; }
  .expand-btn {
    background: none; border: 1px solid #444; color: #888;
    font: 10px monospace; padding: 1px 6px; cursor: pointer;
    border-radius: 3px; margin-left: 4px;
  }
  .expand-btn:hover { border-color: #888; color: #ccc; }

  /* Terminal area in tile */
  .pod-terminal {
    flex: 1;
    padding: 2px;
    min-height: 0;
    overflow: hidden;
  }

  /* Status bar */
  #status {
    height: 24px; line-height: 24px; padding: 0 8px;
    font: 12px/24px monospace; color: #ccc; background: #111;
    display: flex; justify-content: space-between; align-items: center;
    flex-shrink: 0;
  }
  .dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 6px; vertical-align: middle;
  }
  .dot-connected { background: #4ec950; }
  .dot-connecting { background: #e8a317; }
  .dot-disconnected { background: #e04040; }

  /* Empty state */
  #empty {
    display: none; text-align: center; padding: 60px 20px;
    color: #555; font-size: 14px;
  }
  #empty.visible { display: block; }
</style>
</head>
<body>
<div id="header">
  <span style="font-weight:600;color:#ccc;">Coop Multiplexer</span>
  <div class="stats">
    <span><span class="stat-label">Pods:</span> <span class="stat-value" id="stat-total">0</span></span>
    <span><span class="stat-label">Healthy:</span> <span class="stat-value healthy" id="stat-healthy">0</span></span>
    <span><span class="stat-label">Alerts:</span> <span class="stat-value" id="stat-alerts">0</span></span>
  </div>
</div>
<div id="grid">
  <div id="empty" class="visible">No pods connected. Waiting for agents to register...</div>
</div>
<div id="status">
  <span>
    <span id="dot" class="dot dot-connecting"></span>
    <span id="label">Connecting...</span>
  </span>
  <span id="info"></span>
</div>

<script type="module">
import { FitAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
import { WebglAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0.18.0/+esm';
import { Terminal } from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';

const wsProto = location.protocol === 'https:' ? 'wss:' : 'ws:';
// Extract auth token from ?token= query param so we can forward it to WS and API calls.
const AUTH_TOKEN = new URLSearchParams(location.search).get('token') || '';
const tokenParam = AUTH_TOKEN ? `&token=${encodeURIComponent(AUTH_TOKEN)}` : '';
const WS_URL = `${wsProto}//${location.host}/ws/mux?subscribe=state,screen,credentials${tokenParam}`;

const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const dot = document.getElementById('dot');
const lbl = document.getElementById('label');
const infoEl = document.getElementById('info');

// Pod state: { name -> { tile, term, fitAddon, state, credStatus, lastCols, lastRows, resizeTimer } }
const pods = new Map();
let focusedPod = null;
let expandedPod = null;

// Debounced resize â€” sends resize event to pod if terminal dimensions changed.
function syncPodResize(podName) {
  const pod = pods.get(podName);
  if (!pod) return;
  const cols = pod.term.cols;
  const rows = pod.term.rows;
  if (cols === pod.lastCols && rows === pod.lastRows) return;
  pod.lastCols = cols;
  pod.lastRows = rows;
  if (pod.resizeTimer) clearTimeout(pod.resizeTimer);
  pod.resizeTimer = setTimeout(() => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ event: 'input:resize', pod: podName, cols, rows }));
    }
  }, 250);
}

// Fit a pod's terminal and sync its size to the remote.
function fitAndSync(podName) {
  const pod = pods.get(podName);
  if (!pod) return;
  pod.fitAddon.fit();
  syncPodResize(podName);
}

function setStatus(state, text) {
  dot.className = `dot dot-${state}`;
  lbl.textContent = text;
}

function updateStats() {
  const total = pods.size;
  let healthy = 0, alerts = 0;
  for (const [, pod] of pods) {
    if (pod.credStatus === 'alert') alerts++;
    if (pod.state && pod.state !== 'offline' && pod.state !== 'error' && pod.state !== 'exited') healthy++;
  }
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-healthy').textContent = healthy;
  const alertEl = document.getElementById('stat-alerts');
  alertEl.textContent = alerts;
  alertEl.className = `stat-value${alerts > 0 ? ' alert' : ''}`;
  empty.classList.toggle('visible', total === 0);
}

function createPodTile(podName) {
  const tile = document.createElement('div');
  tile.className = 'pod-tile';
  tile.dataset.pod = podName;

  const header = document.createElement('div');
  header.className = 'pod-header';

  const name = document.createElement('span');
  name.className = 'pod-name';
  name.textContent = podName;

  const badge = document.createElement('span');
  badge.className = 'pod-badge starting';
  badge.textContent = 'starting';

  const cred = document.createElement('span');
  cred.className = 'cred-indicator';
  cred.textContent = '';

  const expandBtn = document.createElement('button');
  expandBtn.className = 'expand-btn';
  expandBtn.textContent = '\u2922'; // expand icon
  expandBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleExpand(podName);
  });

  header.appendChild(name);
  header.appendChild(badge);
  header.appendChild(cred);
  header.appendChild(expandBtn);

  const termContainer = document.createElement('div');
  termContainer.className = 'pod-terminal';

  tile.appendChild(header);
  tile.appendChild(termContainer);

  tile.addEventListener('click', () => {
    setFocus(podName);
  });

  grid.appendChild(tile);

  // Create xterm instance
  const term = new Terminal({
    cursorBlink: false,
    scrollback: 500,
    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
    fontSize: 11,
    theme: { background: '#181818' },
    disableStdin: true,
  });
  const fitAddon = new FitAddon();
  term.loadAddon(fitAddon);
  term.open(termContainer);

  try {
    const webgl = new WebglAddon();
    webgl.onContextLoss(() => webgl.dispose());
    term.loadAddon(webgl);
  } catch (_) {}

  requestAnimationFrame(() => fitAndSync(podName));

  // Enable input when focused
  term.onData((str) => {
    if (focusedPod === podName && ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ event: 'input:send', pod: podName, text: str }));
    }
  });

  const podState = {
    tile, term, fitAddon, badge, cred,
    state: 'starting',
    credStatus: 'ok',
    lastCols: 0,
    lastRows: 0,
    resizeTimer: null,
  };
  pods.set(podName, podState);
  updateStats();
  return podState;
}

function removePodTile(podName) {
  const pod = pods.get(podName);
  if (!pod) return;
  pod.term.dispose();
  pod.tile.remove();
  pods.delete(podName);
  if (focusedPod === podName) focusedPod = null;
  if (expandedPod === podName) expandedPod = null;
  updateStats();
}

function setFocus(podName) {
  if (focusedPod) {
    const prev = pods.get(focusedPod);
    if (prev) {
      prev.tile.classList.remove('focused');
      prev.term.options.disableStdin = true;
    }
  }
  focusedPod = podName;
  const pod = pods.get(podName);
  if (pod) {
    pod.tile.classList.add('focused');
    pod.term.options.disableStdin = false;
    pod.term.focus();
  }
}

function toggleExpand(podName) {
  if (expandedPod === podName) {
    // Collapse
    const pod = pods.get(podName);
    if (pod) {
      pod.tile.classList.remove('expanded');
      requestAnimationFrame(() => fitAndSync(podName));
    }
    expandedPod = null;
  } else {
    // Collapse previous
    if (expandedPod) {
      const prevName = expandedPod;
      const prev = pods.get(prevName);
      if (prev) {
        prev.tile.classList.remove('expanded');
        requestAnimationFrame(() => fitAndSync(prevName));
      }
    }
    // Expand new
    expandedPod = podName;
    const pod = pods.get(podName);
    if (pod) {
      pod.tile.classList.add('expanded');
      setFocus(podName);
      requestAnimationFrame(() => fitAndSync(podName));
    }
  }
}

function updateBadge(pod, state) {
  pod.state = state;
  pod.badge.textContent = state;
  pod.badge.className = `pod-badge ${state}`;
  updateStats();
}

function updateCredStatus(pod, status) {
  if (status === 'refresh_failed' || status === 'revoked' || status === 'reauth_required') {
    pod.credStatus = 'alert';
    pod.cred.textContent = '\u26a0 auth';
    pod.cred.className = 'cred-indicator alert';
  } else {
    pod.credStatus = 'ok';
    pod.cred.textContent = '';
    pod.cred.className = 'cred-indicator';
  }
  updateStats();
}

function writeScreen(pod, lines, cols, rows) {
  // Clear and rewrite the full screen snapshot
  pod.term.reset();
  const text = lines.join('\r\n');
  pod.term.write(text);
}

// WebSocket connection
let ws = null;

function connect() {
  setStatus('connecting', 'Connecting...');
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setStatus('connected', `Connected - ${location.host}`);
  };

  ws.onmessage = (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch (_) { return; }

    const type = msg.type;
    const podName = msg.session;

    if (type === 'session_online') {
      if (!pods.has(podName)) createPodTile(podName);
      return;
    }

    if (type === 'session_offline') {
      const pod = pods.get(podName);
      if (pod) updateBadge(pod, 'offline');
      return;
    }

    if (type === 'state') {
      let pod = pods.get(podName);
      if (!pod) pod = createPodTile(podName);
      updateBadge(pod, msg.next || 'unknown');
      return;
    }

    if (type === 'screen') {
      let pod = pods.get(podName);
      if (!pod) pod = createPodTile(podName);
      writeScreen(pod, msg.lines || [], msg.cols || 80, msg.rows || 24);
      return;
    }

    if (type === 'credential') {
      let pod = pods.get(podName);
      if (!pod) pod = createPodTile(podName);
      updateCredStatus(pod, msg.status || '');
      return;
    }

    if (type === 'error') {
      infoEl.textContent = msg.message || 'error';
    }
  };

  ws.onclose = () => {
    setStatus('disconnected', 'Disconnected');
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {};
}

// Refit all terminals on window resize and sync sizes to pods
window.addEventListener('resize', () => {
  for (const [name] of pods) {
    fitAndSync(name);
  }
});

// Keyboard shortcut: Escape to collapse expanded tile
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && expandedPod) {
    toggleExpand(expandedPod);
  }
});

connect();
</script>
</body>
</html>
