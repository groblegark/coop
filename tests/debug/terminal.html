<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Coop Terminal</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; background: #1e1e1e; overflow: hidden; }

  #main { display: flex; height: calc(100% - 24px); }
  #terminal { flex: 1; min-width: 0; padding: 8px; }

  /* --- Sidebar --- */
  #sidebar {
    width: 340px; flex-shrink: 0;
    background: #181818; border-left: 1px solid #333;
    display: flex; flex-direction: column;
    font: 12px/1.5 Menlo, Monaco, monospace; color: #ccc;
    overflow: hidden;
  }
  #sidebar.hidden { display: none; }

  /* --- Resize handle --- */
  #resize-handle {
    width: 5px; flex-shrink: 0;
    cursor: col-resize; background: transparent;
    transition: background 0.15s;
  }
  #resize-handle:hover, #resize-handle.dragging { background: #7cb7ff; }
  #resize-handle.hidden { display: none; }

  /* --- Tab bar --- */
  #tab-bar {
    display: flex; flex-shrink: 0;
    border-bottom: 1px solid #333; background: #151515;
  }
  .tab {
    flex: 1; padding: 6px 0; text-align: center;
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: #666;
    cursor: pointer; border-bottom: 2px solid transparent;
    user-select: none; transition: color 0.15s;
  }
  .tab:hover { color: #aaa; }
  .tab.active { color: #ccc; border-bottom-color: #7cb7ff; }

  /* --- Tab panels --- */
  .tab-panel { display: none; flex: 1; flex-direction: column; min-height: 0; overflow: hidden; }
  .tab-panel.active { display: flex; }

  /* --- State panel --- */
  #sidebar h2 {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: #888; padding: 8px 10px 4px;
    border-bottom: 1px solid #2a2a2a; flex-shrink: 0;
  }
  .api-section { flex: 1; overflow-y: auto; }
  .api-block { padding: 4px 10px; }
  .api-block summary {
    cursor: pointer; font-size: 11px; font-weight: 600; color: #aaa;
    padding: 2px 0; user-select: none;
  }
  .api-block table { width: 100%; border-collapse: collapse; }
  .api-block td {
    padding: 1px 4px; font-size: 11px; vertical-align: top;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 180px;
  }
  .api-block td:first-child { color: #888; width: 90px; }
  .api-block td:last-child { color: #ddd; }

  /* --- Event log --- */
  #event-log {
    flex: 1; overflow-y: auto; padding: 4px 10px;
    font-size: 11px; line-height: 1.4;
  }
  .ev { padding: 2px 0; border-bottom: 1px solid #222; }
  .ev-time { color: #666; }
  .ev-type { font-weight: 600; }
  .ev-type-output       { color: #7cb7ff; }
  .ev-type-pty          { color: #7cb7ff; }
  .ev-type-transition { color: #e8c84a; }
  .ev-type-exit         { color: #e06060; }
  .ev-type-error        { color: #e06060; }
  .ev-type-resize       { color: #6cc; }
  .ev-type-pong         { color: #666; }
  .ev-type-stop         { color: #e8a317; }
  .ev-type-start        { color: #4ec950; }
  .ev-type-prompt { color: #4ec950; }
  .ev-type-session      { color: #b8a0e8; }
  .ev-type-usage        { color: #6cc; }
  .ev-detail { color: #999; margin-left: 4px; }

  /* --- Actions panel --- */
  #actions-panel { padding: 0; }
  .action-section { padding: 8px 10px; border-bottom: 1px solid #2a2a2a; }
  .action-section:last-child { border-bottom: none; }
  .action-label {
    font-size: 10px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: #666; margin-bottom: 4px;
  }
  .action-row { display: flex; gap: 4px; align-items: center; margin-top: 4px; }
  .action-column { display: flex; flex-direction: column; gap: 3px; margin-top: 4px; align-items: flex-start; }
  .action-row input[type="text"],
  .action-row textarea,
  .action-row select,
  .action-column input[type="text"],
  .action-column textarea,
  .action-column select {
    flex: 1; min-width: 0;
    background: #222; border: 1px solid #444; color: #ddd;
    font: 11px Menlo, Monaco, monospace; padding: 3px 6px;
    border-radius: 3px; outline: none;
  }
  .action-row input:focus,
  .action-row textarea:focus,
  .action-row select:focus,
  .action-column input:focus,
  .action-column textarea:focus,
  .action-column select:focus { border-color: #7cb7ff; }
  .action-row textarea,
  .action-column textarea { resize: vertical; min-height: 28px; line-height: 1.4; }
  .action-btn {
    background: #2a2a2a; border: 1px solid #444; color: #ccc;
    font: 11px Menlo, Monaco, monospace; padding: 3px 10px;
    border-radius: 3px; cursor: pointer; white-space: nowrap;
    transition: border-color 0.15s, color 0.15s;
  }
  .action-btn:hover { border-color: #888; color: #fff; }
  .action-btn:active { background: #333; }
  .action-btn.btn-danger { border-color: #a33; color: #e66; }
  .action-btn.btn-danger:hover { border-color: #e66; color: #f88; }
  .action-btn.btn-success { border-color: #3a3; color: #6c6; }
  .action-btn.btn-success:hover { border-color: #6c6; color: #8e8; }
  .action-btn.btn-warn { border-color: #a83; color: #ec6; }
  .action-btn.btn-warn:hover { border-color: #ec6; color: #fe8; }
  .key-grid { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
  .key-btn {
    background: #252525; border: 1px solid #3a3a3a; color: #aaa;
    font: 10px Menlo, Monaco, monospace; padding: 2px 6px;
    border-radius: 3px; cursor: pointer; transition: all 0.1s;
  }
  .key-btn:hover { border-color: #666; color: #ddd; background: #2e2e2e; }
  .key-btn:active { background: #333; }
  .action-result {
    font-size: 10px; color: #666; margin-top: 4px;
    max-height: 40px; overflow-y: auto; word-break: break-all;
  }
  .action-result.ok { color: #6c6; }
  .action-result.err { color: #e66; }
  .action-check { margin: 0; accent-color: #7cb7ff; }
  .action-check-label { font-size: 10px; color: #888; margin-left: 2px; }
  .fallback-badge {
    font-size: 10px; color: #e8a317; border: 1px solid #a83;
    border-radius: 3px; padding: 1px 6px; margin-bottom: 4px;
    display: inline-block;
  }
  .action-btn.btn-fallback { border-style: dashed; opacity: 0.85; }

  /* --- Status bar --- */
  #status {
    height: 24px; line-height: 24px; padding: 0 8px;
    font: 12px/24px monospace; color: #ccc; background: #111;
    display: flex; justify-content: space-between; align-items: center;
    flex-shrink: 0;
  }
  #status .dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 6px; vertical-align: middle;
  }
  .dot-connected    { background: #4ec950; }
  .dot-connecting   { background: #e8a317; }
  .dot-disconnected { background: #e04040; }
  #toggle-btn {
    background: none; border: 1px solid #555; color: #aaa;
    font: 11px monospace; padding: 1px 8px; cursor: pointer;
    border-radius: 3px; margin-left: 8px;
  }
  #toggle-btn:hover { border-color: #888; color: #ddd; }
  #agent-state {
    font-weight: 600; margin-right: 12px;
    padding: 1px 8px; border-radius: 3px;
    border: 1px solid #444; color: #ccc;
    display: none;
  }
  #agent-state.visible { display: inline; }
  #agent-state.st-working         { border-color: #4e8; color: #4e8; }
  #agent-state.st-idle { border-color: #e8a317; color: #e8a317; }
  #agent-state.st-prompt           { border-color: #7cb7ff; color: #7cb7ff; }
  #agent-state.st-setup           { border-color: #b8a0e8; color: #b8a0e8; }
  #agent-state.st-error           { border-color: #e06060; color: #e06060; }
  #agent-state.st-exited          { border-color: #888; color: #888; }
</style>
</head>
<body>
<div id="main">
  <div id="terminal"></div>
  <div id="resize-handle"></div>
  <div id="sidebar">
    <div id="tab-bar">
      <div class="tab active" data-tab="state">State</div>
      <div class="tab" data-tab="events">Events</div>
      <div class="tab" data-tab="actions">Actions</div>
    </div>

    <!-- State panel -->
    <div id="panel-state" class="tab-panel active">
      <div class="api-section">
        <div class="api-block">
          <details open><summary>Health</summary><table id="t-health"></table></details>
        </div>
        <div class="api-block">
          <details open><summary>Status</summary><table id="t-status"></table></details>
        </div>
        <div class="api-block">
          <details open><summary>Agent</summary><table id="t-agent"></table></details>
        </div>
        <div class="api-block">
          <details open><summary>Usage</summary><table id="t-usage"></table></details>
        </div>
      </div>
    </div>

    <!-- Events panel -->
    <div id="panel-events" class="tab-panel">
      <div id="event-log"></div>
    </div>

    <!-- Actions panel -->
    <div id="panel-actions" class="tab-panel">
      <div style="flex:1; overflow-y:auto;">

        <!-- Send Input -->
        <div class="action-section">
          <div class="action-label">Input</div>
          <div class="action-row">
            <input type="text" id="act-input" placeholder="Text to send..." />
            <label><input type="checkbox" id="act-input-enter" class="action-check" checked /><span class="action-check-label">Enter</span></label>
            <button class="action-btn" id="act-input-send">Send</button>
          </div>
          <div id="act-input-result" class="action-result"></div>
        </div>

        <!-- Keys -->
        <div class="action-section">
          <div class="action-label">Keys</div>
          <div class="key-grid" id="key-grid"></div>
        </div>

        <!-- Signal -->
        <div class="action-section">
          <div class="action-label">Signal</div>
          <div class="action-row">
            <button class="action-btn" data-signal="SIGINT">SIGINT</button>
            <button class="action-btn btn-warn" data-signal="SIGTERM">SIGTERM</button>
            <button class="action-btn btn-danger" data-signal="SIGKILL">SIGKILL</button>
          </div>
          <div class="action-row">
            <button class="action-btn" data-signal="SIGTSTP">SIGTSTP</button>
            <button class="action-btn" data-signal="SIGCONT">SIGCONT</button>
            <button class="action-btn" data-signal="SIGHUP">SIGHUP</button>
          </div>
          <div id="act-signal-result" class="action-result"></div>
        </div>

        <!-- Nudge -->
        <div class="action-section">
          <div class="action-label">Nudge</div>
          <div class="action-row">
            <input type="text" id="act-nudge" placeholder="Nudge message..." />
            <button class="action-btn btn-warn" id="act-nudge-send">Nudge</button>
          </div>
          <div id="act-nudge-result" class="action-result"></div>
        </div>

        <!-- Respond -->
        <div class="action-section">
          <div class="action-label">Respond to Prompt <span id="act-respond-kind" style="color:#7cb7ff;"></span></div>
          <div id="act-respond-none" style="font-size:10px;color:#555;">No active prompt</div>
          <div id="act-respond-last-msg" style="display:none;font-size:10px;color:#aaa;margin-bottom:6px;padding:4px 6px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:3px;white-space:pre-wrap;word-break:break-word;max-height:100px;overflow-y:auto;"></div>

          <!-- Permission prompt: numbered options -->
          <div id="act-respond-permission" style="display:none;">
            <div id="act-respond-perm-info" style="font-size:10px;color:#888;margin-bottom:4px;white-space:pre-wrap;word-break:break-word;max-height:80px;overflow-y:auto;"></div>
            <div id="act-respond-perm-fallback" class="fallback-badge" style="display:none;">fallback — parser couldn't find real options</div>
            <div id="act-respond-perm-options" class="action-column"></div>
          </div>

          <!-- Plan prompt: numbered options with feedback -->
          <div id="act-respond-plan" style="display:none;">
            <div id="act-respond-plan-info" style="font-size:10px;color:#aaa;margin-bottom:6px;padding:4px 6px;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:3px;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto;"></div>
            <div id="act-respond-plan-fallback" class="fallback-badge" style="display:none;">fallback — parser couldn't find real options</div>
            <div id="act-respond-plan-options" class="action-column"></div>
            <div class="action-column" style="margin-top:8px;padding-top:8px;border-top:1px solid #2a2a2a;">
              <input type="text" id="act-plan-feedback" placeholder="Feedback (last option)..." style="width:100%;" />
              <button class="action-btn btn-warn" id="act-plan-feedback-send">Feedback</button>
            </div>
          </div>

          <!-- Setup prompt: numbered options -->
          <div id="act-respond-setup" style="display:none;">
            <div id="act-respond-setup-info" style="font-size:10px;color:#888;margin-bottom:4px;"></div>
            <div id="act-respond-setup-auth" style="display:none;margin-bottom:6px;">
              <div style="font-size:10px;color:#b8a0e8;margin-bottom:2px;">Auth URL:</div>
              <div class="action-row">
                <input type="text" id="act-setup-auth-url" readonly style="font-size:10px;color:#7cb7ff;cursor:text;" />
                <button class="action-btn" id="act-setup-auth-copy">Copy</button>
                <button class="action-btn btn-success" id="act-setup-auth-open">Open</button>
              </div>
            </div>
            <div id="act-respond-setup-options" class="action-column"></div>
          </div>

          <!-- Question prompt: show question + options -->
          <div id="act-respond-question" style="display:none;">
            <div id="act-question-text" style="font-size:10px;color:#aaa;margin-bottom:4px;"></div>
            <div id="act-question-options" class="action-column"></div>
            <div class="action-row" style="margin-top:4px;">
              <input type="text" id="act-question-freeform" placeholder="Other (freeform text)..." />
              <button class="action-btn" id="act-question-freeform-send">Send</button>
            </div>
          </div>

          <div id="act-respond-result" class="action-result"></div>
        </div>

        <!-- Session Switch -->
        <div class="action-section">
          <div class="action-label">Session Switch</div>
          <div class="action-row">
            <textarea id="act-switch-creds" rows="2" placeholder='{"ANTHROPIC_API_KEY": "sk-ant-..."}'></textarea>
          </div>
          <div class="action-row">
            <label><input type="checkbox" id="act-switch-force" class="action-check" /><span class="action-check-label">Force (skip idle wait)</span></label>
            <button class="action-btn btn-warn" id="act-switch-send">Switch</button>
          </div>
          <div id="act-switch-result" class="action-result"></div>
        </div>

        <!-- Stop Config -->
        <div class="action-section">
          <div class="action-label">Stop Config</div>
          <div class="action-row">
            <select id="act-stop-mode">
              <option value="allow">allow</option>
              <option value="signal">signal</option>
            </select>
            <button class="action-btn" id="act-stop-get">Get</button>
            <button class="action-btn" id="act-stop-put">Put</button>
          </div>
          <div class="action-row">
            <input type="text" id="act-stop-prompt" placeholder="Block reason (optional)" />
          </div>
          <div id="act-stop-result" class="action-result"></div>
        </div>

        <!-- Start Config -->
        <div class="action-section">
          <div class="action-label">Start Config</div>
          <div class="action-row">
            <button class="action-btn" id="act-start-get">Get</button>
            <button class="action-btn" id="act-start-put">Put</button>
          </div>
          <div class="action-row">
            <textarea id="act-start-json" rows="2" placeholder='{"mode":"allow"}'></textarea>
          </div>
          <div id="act-start-result" class="action-result"></div>
        </div>

        <!-- Shutdown -->
        <div class="action-section">
          <div class="action-label">Lifecycle</div>
          <div class="action-row">
            <button class="action-btn btn-danger" id="act-shutdown">Shutdown</button>
          </div>
          <div id="act-shutdown-result" class="action-result"></div>
        </div>

        <!-- Resize -->
        <div class="action-section">
          <div class="action-label">Resize</div>
          <div class="action-row">
            <input type="text" id="act-resize-cols" placeholder="cols" style="width:60px;flex:none;" />
            <span style="color:#666;">x</span>
            <input type="text" id="act-resize-rows" placeholder="rows" style="width:60px;flex:none;" />
            <button class="action-btn" id="act-resize-send">Resize</button>
          </div>
          <div id="act-resize-result" class="action-result"></div>
        </div>

      </div>
    </div>

  </div>
</div>
<div id="status">
  <span>
    <span id="dot" class="dot dot-connecting"></span>
    <span id="label">Connecting…</span>
  </span>
  <span>
    <span id="agent-state"></span>
    <span id="info"></span>
    <button id="toggle-btn">Hide</button>
  </span>
</div>

<script type="module">
import { FitAddon }  from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
import { WebglAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-webgl@0.18.0/+esm';
import { Terminal }  from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';

const params = new URLSearchParams(location.search);
const PORT = params.get('port') || '7070';
const BASE = `http://localhost:${PORT}`;
const WS_URL = `ws://localhost:${PORT}/ws?subscribe=pty,state,usage`;

const dot        = document.getElementById('dot');
const label      = document.getElementById('label');
const info       = document.getElementById('info');
const agentState = document.getElementById('agent-state');

function setAgentState(state) {
  agentState.textContent = state;
  agentState.className = `visible st-${state}`;
}

function setStatus(state, text) {
  dot.className = `dot dot-${state}`;
  label.textContent = text;
}

const term = new Terminal({
  cursorBlink: true,
  scrollback: 10000,
  fontFamily: 'Menlo, Monaco, "Courier New", monospace',
  fontSize: 14,
  theme: { background: '#1e1e1e' },
});

const fitAddon = new FitAddon();
term.loadAddon(fitAddon);
term.open(document.getElementById('terminal'));

try {
  const webgl = new WebglAddon();
  webgl.onContextLoss(() => webgl.dispose());
  term.loadAddon(webgl);
} catch (_) {
  // canvas fallback is automatic
}

fitAddon.fit();
term.focus();

let activeTab = 'state';
const tabs = document.querySelectorAll('#tab-bar .tab');
const panels = {
  state:   document.getElementById('panel-state'),
  events:  document.getElementById('panel-events'),
  actions: document.getElementById('panel-actions'),
};

function switchTab(name) {
  activeTab = name;
  tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  for (const [k, p] of Object.entries(panels)) p.classList.toggle('active', k === name);
}

tabs.forEach(t => t.addEventListener('click', () => {
  switchTab(t.dataset.tab);
  term.focus();
}));

const sidebar = document.getElementById('sidebar');
const toggleBtn = document.getElementById('toggle-btn');
let sidebarVisible = true;

function setSidebarVisible(show) {
  sidebarVisible = show;
  sidebar.classList.toggle('hidden', !show);
  document.getElementById('resize-handle').classList.toggle('hidden', !show);
  toggleBtn.textContent = show ? 'Hide' : 'Inspector';
  // refit terminal after layout change
  requestAnimationFrame(() => fitAddon.fit());
}

toggleBtn.addEventListener('click', () => {
  setSidebarVisible(!sidebarVisible);
  term.focus();
});

const tHealth = document.getElementById('t-health');
const tStatus = document.getElementById('t-status');
const tAgent  = document.getElementById('t-agent');
const tUsage  = document.getElementById('t-usage');

function renderTable(el, obj, prefix) {
  if (!obj) { el.innerHTML = '<tr><td colspan="2" style="color:#666">--</td></tr>'; return; }
  el.innerHTML = renderRows(obj, prefix);
}

function renderRows(obj, prefix) {
  let html = '';
  const entries = Array.isArray(obj)
    ? obj.map((v, i) => [String(i), v])
    : Object.entries(obj);
  for (const [k, v] of entries) {
    const key = prefix ? `${prefix}.${k}` : k;
    if (v != null && typeof v === 'object') {
      html += renderRows(v, key);
    } else {
      html += `<tr><td>${key}</td><td>${esc(v)}</td></tr>`;
    }
  }
  return html;
}

function esc(v) {
  const s = String(v ?? '--');
  const el = document.createElement('span');
  el.textContent = s;
  return el.innerHTML;
}

async function pollAgentState() {
  try {
    const agent = await fetch(`${BASE}/api/v1/agent`).then(r => r.ok ? r.json() : null);
    if (agent?.state) {
      setAgentState(agent.state);
      updateRespondUI(agent.prompt ?? null, agent.last_message ?? null);
    }
  } catch (_) { /* ignore */ }
}

async function pollApi() {
  pollAgentState();
  if (!sidebarVisible || activeTab !== 'state') return;
  try {
    const [health, status, agent, usage] = await Promise.all([
      fetch(`${BASE}/api/v1/health`).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch(`${BASE}/api/v1/status`).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch(`${BASE}/api/v1/agent`).then(r => r.ok ? r.json() : null).catch(() => null),
      fetch(`${BASE}/api/v1/session/usage`).then(r => r.ok ? r.json() : null).catch(() => null),
    ]);
    renderTable(tHealth, health, '');
    renderTable(tStatus, status, '');
    renderTable(tAgent, agent, '');
    renderTable(tUsage, usage, '');
  } catch (_) { /* ignore */ }
}

const pollTimer = setInterval(pollApi, 2000);
pollApi();

const eventLog = document.getElementById('event-log');
const MAX_EVENTS = 200;
let eventCount = 0;

// Collapse consecutive pty bursts into a single updating row.
let streamEl = null;   // current collapsed row element
let streamAcc = null;  // { count, totalBytes, lastOffset }

// Collapse consecutive pong events into a single updating row.
let pongEl = null;
let pongCount = 0;

function logEvent(msg) {
  const type = msg.event || '?';
  const now = new Date();
  const ts = now.toTimeString().slice(0, 8);

  // Collapse consecutive pty bursts in-place
  if (type === 'pty' || type === 'replay') {
    pongEl = null; pongCount = 0;
    const len = msg.data ? atob(msg.data).length : 0;
    if (streamEl && streamAcc) {
      streamAcc.count++;
      streamAcc.totalBytes += len;
      streamAcc.lastOffset = msg.offset + len;
      streamEl.innerHTML = renderStreamHtml(ts, streamAcc);
      autoScroll();
      return;
    }
    streamAcc = { count: 1, totalBytes: len, lastOffset: msg.offset + len };
    const div = document.createElement('div');
    div.className = 'ev';
    div.innerHTML = renderStreamHtml(ts, streamAcc);
    eventLog.appendChild(div);
    streamEl = div;
    eventCount++;
    trimEvents();
    autoScroll();
    return;
  }

  // Collapse consecutive pong events in-place
  if (type === 'pong') {
    streamEl = null; streamAcc = null;
    pongCount++;
    if (pongEl) {
      pongEl.innerHTML = renderPongHtml(ts, pongCount);
      autoScroll();
      return;
    }
    const div = document.createElement('div');
    div.className = 'ev';
    div.innerHTML = renderPongHtml(ts, pongCount);
    eventLog.appendChild(div);
    pongEl = div;
    eventCount++;
    trimEvents();
    autoScroll();
    return;
  }

  // Non-collapsible event — break all collapsed runs
  streamEl = null;
  streamAcc = null;
  pongEl = null;
  pongCount = 0;

  let detail = '';
  switch (type) {
    case 'transition':
      detail = `${msg.prev} -> ${msg.next}`;
      if (msg.cause) detail += ` [${msg.cause}]`;
      if (msg.error_detail) detail += ` (${msg.error_category || 'error'})`;
      break;
    case 'exit':
      detail = msg.signal != null ? `signal ${msg.signal}` : `code ${msg.code ?? '?'}`;
      break;
    case 'error':
      detail = `${msg.code}: ${msg.message}`;
      break;
    case 'resize':
      detail = `${msg.cols}x${msg.rows}`;
      break;
    case 'stop:outcome':
      detail = msg.type || '';
      break;
    case 'start:outcome':
      detail = msg.source || '';
      if (msg.session_id) detail += ` session=${msg.session_id}`;
      if (msg.injected) detail += ' (injected)';
      break;
    case 'prompt:outcome':
      detail = `${msg.source}: ${msg.type || '?'}`;
      if (msg.subtype) detail += `(${msg.subtype})`;
      if (msg.option != null) detail += ` opt=${msg.option}`;
      break;
    case 'session:switched':
      detail = msg.scheduled ? 'scheduled' : 'immediate';
      break;
    case 'usage:update':
      detail = msg.cumulative
        ? `in=${msg.cumulative.input_tokens} out=${msg.cumulative.output_tokens} $${msg.cumulative.total_cost_usd?.toFixed(4) ?? '?'} seq=${msg.seq}`
        : `seq=${msg.seq}`;
      break;
  }

  const div = document.createElement('div');
  div.className = 'ev';
  div.innerHTML = renderEvHtml(ts, type, detail);
  eventLog.appendChild(div);

  eventCount++;
  trimEvents();
  autoScroll();
}

function renderStreamHtml(ts, acc) {
  return `<span class="ev-time">${ts}</span> ` +
    `<span class="ev-type ev-type-pty">pty</span>` +
    `<span class="ev-detail">${acc.count}x ${acc.totalBytes}B thru ${acc.lastOffset}</span>`;
}

function renderPongHtml(ts, count) {
  return `<span class="ev-time">${ts}</span> ` +
    `<span class="ev-type ev-type-pong">pong</span>` +
    `<span class="ev-detail">${count}x</span>`;
}

function renderEvHtml(ts, type, detail) {
  const cssType = type.split(':')[0];
  return `<span class="ev-time">${ts}</span> ` +
    `<span class="ev-type ev-type-${cssType}">${type}</span>` +
    (detail ? `<span class="ev-detail">${esc(detail)}</span>` : '');
}

function trimEvents() {
  while (eventCount > MAX_EVENTS) {
    if (eventLog.firstChild === streamEl) { streamEl = null; streamAcc = null; }
    if (eventLog.firstChild === pongEl) { pongEl = null; pongCount = 0; }
    eventLog.removeChild(eventLog.firstChild);
    eventCount--;
  }
}

function autoScroll() {
  if (eventLog.scrollHeight - eventLog.scrollTop - eventLog.clientHeight < 60) {
    eventLog.scrollTop = eventLog.scrollHeight;
  }
}

function send(ws, msg) {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(msg));
  }
}

function b64decode(str) {
  const bin = atob(str);
  const buf = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) buf[i] = bin.charCodeAt(i);
  return buf;
}

function b64encode(bytes) {
  let bin = '';
  for (const b of bytes) bin += String.fromCharCode(b);
  return btoa(bin);
}

async function apiPost(path, body) {
  const res = await fetch(`${BASE}${path}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch (_) { json = null; }
  return { ok: res.ok, status: res.status, json, text };
}

async function apiPut(path, body) {
  const res = await fetch(`${BASE}${path}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch (_) { json = null; }
  return { ok: res.ok, status: res.status, json, text };
}

async function apiGet(path) {
  const res = await fetch(`${BASE}${path}`);
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch (_) { json = null; }
  return { ok: res.ok, status: res.status, json, text };
}

function showResult(elId, res) {
  const el = document.getElementById(elId);
  el.className = 'action-result ' + (res.ok ? 'ok' : 'err');
  const display = res.json ? JSON.stringify(res.json) : res.text;
  el.textContent = `${res.status}: ${display}`;
}

document.getElementById('act-input-send').addEventListener('click', async () => {
  const text = document.getElementById('act-input').value;
  const enter = document.getElementById('act-input-enter').checked;
  const payload = { text, enter };
  const res = await apiPost('/api/v1/input', payload);
  showResult('act-input-result', res);
  document.getElementById('act-input').value = '';
});

document.getElementById('act-input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('act-input-send').click();
  }
});

const KEY_DEFS = [
  'enter', 'escape', 'tab', 'backspace', 'delete',
  'up', 'down', 'left', 'right',
  'ctrl-c', 'ctrl-d', 'ctrl-z', 'ctrl-l', 'ctrl-a', 'ctrl-e',
];
const keyGrid = document.getElementById('key-grid');
for (const key of KEY_DEFS) {
  const btn = document.createElement('button');
  btn.className = 'key-btn';
  btn.textContent = key;
  btn.addEventListener('click', () => {
    send(ws, { event: 'keys:send', keys: [key] });
  });
  keyGrid.appendChild(btn);
}

document.querySelectorAll('[data-signal]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const res = await apiPost('/api/v1/signal', { signal: btn.dataset.signal });
    showResult('act-signal-result', res);
  });
});

document.getElementById('act-nudge-send').addEventListener('click', async () => {
  const message = document.getElementById('act-nudge').value;
  const res = await apiPost('/api/v1/agent/nudge', { message });
  showResult('act-nudge-result', res);
  if (res.ok) document.getElementById('act-nudge').value = '';
});

document.getElementById('act-nudge').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('act-nudge-send').click();
  }
});

let currentPrompt = null;  // PromptContext from last transition

const respondPanels = {
  none: document.getElementById('act-respond-none'),
  permission: document.getElementById('act-respond-permission'),
  setup: document.getElementById('act-respond-setup'),
  plan: document.getElementById('act-respond-plan'),
  question: document.getElementById('act-respond-question'),
};

function updateRespondUI(prompt, lastMessage) {
  currentPrompt = prompt;
  const kindEl = document.getElementById('act-respond-kind');
  const lastMsgEl = document.getElementById('act-respond-last-msg');

  // Hide all panels
  for (const p of Object.values(respondPanels)) p.style.display = 'none';

  if (!prompt) {
    respondPanels.none.style.display = '';
    kindEl.textContent = '';
    lastMsgEl.style.display = 'none';
    return;
  }

  // Show last assistant message if available
  if (lastMessage) {
    lastMsgEl.textContent = lastMessage;
    lastMsgEl.style.display = '';
  } else {
    lastMsgEl.style.display = 'none';
  }

  kindEl.textContent = `(${prompt.type})`;

  if (prompt.type === 'permission') {
    respondPanels.permission.style.display = '';
    const info = document.getElementById('act-respond-perm-info');
    const parts = [];
    if (prompt.tool) parts.push(`Tool: ${prompt.tool}`);
    if (prompt.input) parts.push(prompt.input);
    info.textContent = parts.join('\n') || '';
    info.style.display = parts.length ? '' : 'none';
    const isFallback = !!prompt.options_fallback;
    document.getElementById('act-respond-perm-fallback').style.display = isFallback ? '' : 'none';
    // Dynamic options from screen parsing, with hardcoded fallback
    const permOptsEl = document.getElementById('act-respond-perm-options');
    permOptsEl.innerHTML = '';
    const permOpts = prompt.options?.length ? prompt.options : ['Yes', "Yes, and don't ask again", 'No'];
    const permStyles = isFallback ? ['btn-success btn-fallback', 'btn-danger btn-fallback'] : ['btn-success', 'btn-warn', 'btn-danger'];
    permOpts.forEach((label, i) => {
      const btn = document.createElement('button');
      btn.className = `action-btn ${permStyles[i] || ''}`;
      btn.textContent = `${i + 1}. ${label}`;
      btn.addEventListener('click', async () => {
        const res = await apiPost('/api/v1/agent/respond', { option: i + 1 });
        showResult('act-respond-result', res);
      });
      permOptsEl.appendChild(btn);
    });
  } else if (prompt.type === 'setup') {
    respondPanels.setup.style.display = '';
    const setupInfoEl = document.getElementById('act-respond-setup-info');
    setupInfoEl.textContent = prompt.subtype ? `Subtype: ${prompt.subtype}` : '';
    // Auth URL (oauth_login prompts)
    const authPanel = document.getElementById('act-respond-setup-auth');
    const authUrlInput = document.getElementById('act-setup-auth-url');
    if (prompt.subtype === 'oauth_login' && prompt.input) {
      authPanel.style.display = '';
      authUrlInput.value = prompt.input;
    } else {
      authPanel.style.display = 'none';
      authUrlInput.value = '';
    }
    const setupOptsEl = document.getElementById('act-respond-setup-options');
    setupOptsEl.innerHTML = '';
    const setupOpts = prompt.options?.length ? prompt.options : ['Continue'];
    setupOpts.forEach((label, i) => {
      const btn = document.createElement('button');
      btn.className = 'action-btn';
      btn.textContent = `${i + 1}. ${label}`;
      btn.addEventListener('click', async () => {
        const res = await apiPost('/api/v1/agent/respond', { option: i + 1 });
        showResult('act-respond-result', res);
      });
      setupOptsEl.appendChild(btn);
    });
  } else if (prompt.type === 'plan') {
    respondPanels.plan.style.display = '';
    document.getElementById('act-plan-feedback').value = '';
    // Show plan input context — extract the plan text from ExitPlanMode tool input
    const planInfo = document.getElementById('act-respond-plan-info');
    if (prompt.input) {
      try {
        const parsed = JSON.parse(prompt.input);
        planInfo.textContent = parsed.plan || JSON.stringify(parsed, null, 2);
      } catch (_) {
        planInfo.textContent = prompt.input;
      }
      planInfo.style.display = '';
    } else {
      planInfo.textContent = '';
      planInfo.style.display = 'none';
    }
    const isFallback = !!prompt.options_fallback;
    document.getElementById('act-respond-plan-fallback').style.display = isFallback ? '' : 'none';
    // Dynamic options from screen parsing, with hardcoded fallback
    const planOptsEl = document.getElementById('act-respond-plan-options');
    planOptsEl.innerHTML = '';
    const planOpts = prompt.options?.length ? prompt.options : ['Start with clear context', 'Auto-accept edits', 'Review each edit', 'Provide feedback'];
    const planStyles = isFallback ? ['btn-success btn-fallback', 'btn-danger btn-fallback'] : ['btn-success', 'btn-success', '', 'btn-warn'];
    // Render all options except the last as buttons; the last becomes the feedback row
    const buttonOpts = planOpts.slice(0, -1);
    buttonOpts.forEach((label, i) => {
      const btn = document.createElement('button');
      btn.className = `action-btn ${planStyles[i] || ''}`;
      btn.textContent = `${i + 1}. ${label}`;
      btn.addEventListener('click', async () => {
        const res = await apiPost('/api/v1/agent/respond', { option: i + 1 });
        showResult('act-respond-result', res);
      });
      planOptsEl.appendChild(btn);
    });
    // Update feedback row to reference the last option
    const fbBtn = document.getElementById('act-plan-feedback-send');
    const lastIdx = planOpts.length;
    const lastLabel = planOpts[planOpts.length - 1];
    fbBtn.textContent = `${lastIdx}. ${lastLabel}`;
    document.getElementById('act-plan-feedback').placeholder = `${lastLabel}...`;
  } else if (prompt.type === 'question') {
    respondPanels.question.style.display = '';
    const q = prompt.questions?.[prompt.question_current ?? 0];
    const textEl = document.getElementById('act-question-text');
    const optsEl = document.getElementById('act-question-options');
    optsEl.innerHTML = '';
    if (q) {
      textEl.textContent = q.question;
      q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'key-btn';
        btn.textContent = `${i + 1}. ${opt}`;
        btn.addEventListener('click', async () => {
          const res = await apiPost('/api/v1/agent/respond', { answers: [{ option: i + 1 }] });
          showResult('act-respond-result', res);
        });
        optsEl.appendChild(btn);
      });
    } else {
      textEl.textContent = prompt.question_current >= (prompt.questions?.length ?? 0)
        ? '(confirm phase)' : '(no question data)';
    }
    document.getElementById('act-question-freeform').value = '';
  }
}

// Plan feedback handler (option = last option index)
document.getElementById('act-plan-feedback-send').addEventListener('click', async () => {
  const feedback = document.getElementById('act-plan-feedback').value || undefined;
  // Feedback uses the last option number
  const planOptsEl = document.getElementById('act-respond-plan-options');
  const lastOption = planOptsEl.children.length;
  const res = await apiPost('/api/v1/agent/respond', { option: lastOption, text: feedback });
  showResult('act-respond-result', res);
});
document.getElementById('act-plan-feedback').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('act-plan-feedback-send').click();
  }
});

// Setup auth URL handlers
document.getElementById('act-setup-auth-copy').addEventListener('click', () => {
  const url = document.getElementById('act-setup-auth-url').value;
  navigator.clipboard.writeText(url).then(() => {
    document.getElementById('act-setup-auth-copy').textContent = 'Copied!';
    setTimeout(() => { document.getElementById('act-setup-auth-copy').textContent = 'Copy'; }, 1500);
  });
});
document.getElementById('act-setup-auth-open').addEventListener('click', () => {
  const url = document.getElementById('act-setup-auth-url').value;
  if (url) window.open(url, '_blank');
});

// Question freeform handler
document.getElementById('act-question-freeform-send').addEventListener('click', async () => {
  const text = document.getElementById('act-question-freeform').value;
  const res = await apiPost('/api/v1/agent/respond', { answers: [{ text }] });
  showResult('act-respond-result', res);
  if (res.ok) document.getElementById('act-question-freeform').value = '';
});
document.getElementById('act-question-freeform').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('act-question-freeform-send').click();
  }
});

document.getElementById('act-stop-get').addEventListener('click', async () => {
  const res = await apiGet('/api/v1/config/stop');
  showResult('act-stop-result', res);
  if (res.ok && res.json) {
    document.getElementById('act-stop-mode').value = res.json.mode || 'allow';
    document.getElementById('act-stop-prompt').value = res.json.prompt || '';
  }
});

document.getElementById('act-stop-put').addEventListener('click', async () => {
  const mode = document.getElementById('act-stop-mode').value;
  const prompt = document.getElementById('act-stop-prompt').value || null;
  const res = await apiPut('/api/v1/config/stop', { mode, prompt });
  showResult('act-stop-result', res);
});

document.getElementById('act-start-get').addEventListener('click', async () => {
  const res = await apiGet('/api/v1/config/start');
  showResult('act-start-result', res);
  if (res.ok && res.json) {
    document.getElementById('act-start-json').value = JSON.stringify(res.json, null, 2);
  }
});

document.getElementById('act-start-put').addEventListener('click', async () => {
  const text = document.getElementById('act-start-json').value;
  let body;
  try { body = JSON.parse(text); } catch (_) {
    document.getElementById('act-start-result').className = 'action-result err';
    document.getElementById('act-start-result').textContent = 'Invalid JSON';
    return;
  }
  const res = await apiPut('/api/v1/config/start', body);
  showResult('act-start-result', res);
});

document.getElementById('act-switch-send').addEventListener('click', async () => {
  const credsText = document.getElementById('act-switch-creds').value.trim();
  const force = document.getElementById('act-switch-force').checked;
  let credentials = null;
  if (credsText) {
    try { credentials = JSON.parse(credsText); } catch (_) {
      document.getElementById('act-switch-result').className = 'action-result err';
      document.getElementById('act-switch-result').textContent = 'Invalid JSON';
      return;
    }
  }
  const body = { force };
  if (credentials) body.credentials = credentials;
  const res = await apiPost('/api/v1/session/switch', body);
  showResult('act-switch-result', res);
});

document.getElementById('act-shutdown').addEventListener('click', async () => {
  const res = await apiPost('/api/v1/shutdown', {});
  showResult('act-shutdown-result', res);
});

document.getElementById('act-resize-send').addEventListener('click', async () => {
  const cols = parseInt(document.getElementById('act-resize-cols').value, 10);
  const rows = parseInt(document.getElementById('act-resize-rows').value, 10);
  if (!cols || !rows || cols < 1 || rows < 1) {
    document.getElementById('act-resize-result').className = 'action-result err';
    document.getElementById('act-resize-result').textContent = 'Invalid cols/rows';
    return;
  }
  const res = await apiPost('/api/v1/resize', { cols, rows });
  showResult('act-resize-result', res);
});

let ws = null;
let pingTimer = null;

function connect() {
  setStatus('connecting', 'Connecting…');
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setStatus('connected', `Connected — localhost:${PORT}`);

    // Replay full history
    send(ws, { event: 'replay:get', offset: 0 });

    // Send initial resize
    send(ws, { event: 'resize', cols: term.cols, rows: term.rows });

    // Keep-alive ping every 15s
    pingTimer = setInterval(() => {
      send(ws, { event: 'ping' });
    }, 15_000);

    // Kick off an API poll on connect
    pollApi();
  };

  ws.onmessage = (ev) => {
    let msg;
    try { msg = JSON.parse(ev.data); } catch (_) { return; }

    // Log all events to sidebar
    logEvent(msg);

    if (msg.event === 'pty' || msg.event === 'replay') {
      const bytes = b64decode(msg.data);
      term.write(bytes);
      info.textContent = `offset: ${msg.offset + bytes.length}`;
    } else if (msg.event === 'transition') {
      setAgentState(msg.next);
      updateRespondUI(msg.prompt ?? null, msg.last_message ?? null);
    } else if (msg.event === 'exit') {
      const desc = msg.signal != null ? `signal ${msg.signal}` : `code ${msg.code ?? '?'}`;
      setStatus('disconnected', `Exited (${desc})`);
      setAgentState('exited');
    } else if (msg.event === 'usage:update' && msg.cumulative) {
      renderTable(tUsage, { ...msg.cumulative, uptime_secs: '(live)' }, '');
    } else if (msg.event === 'error') {
      console.warn('server error:', msg.code, msg.message);
    }
  };

  ws.onclose = () => {
    cleanup();
    setStatus('disconnected', 'Disconnected');
    setTimeout(connect, 2000);
  };

  ws.onerror = () => {
    // onclose will fire after this
  };
}

function cleanup() {
  clearInterval(pingTimer);
  pingTimer = null;
}

const encoder = new TextEncoder();

term.onData((str) => {
  const bytes = encoder.encode(str);
  send(ws, { event: 'input:send:raw', data: b64encode(bytes) });
});

term.onBinary((data) => {
  const bytes = new Uint8Array(data.length);
  for (let i = 0; i < data.length; i++) bytes[i] = data.charCodeAt(i);
  send(ws, { event: 'input:send:raw', data: b64encode(bytes) });
});

window.addEventListener('resize', () => fitAddon.fit());

term.onResize(({ cols, rows }) => {
  send(ws, { event: 'resize', cols, rows });
});

const resizeHandle = document.getElementById('resize-handle');
const MIN_SIDEBAR = 300;
const MAX_SIDEBAR = 600;

resizeHandle.addEventListener('mousedown', (e) => {
  e.preventDefault();
  resizeHandle.classList.add('dragging');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';

  const onMove = (e) => {
    const right = window.innerWidth - e.clientX;
    const clamped = Math.min(MAX_SIDEBAR, Math.max(MIN_SIDEBAR, right));
    sidebar.style.width = clamped + 'px';
    fitAddon.fit();
  };

  const onUp = () => {
    resizeHandle.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
    window.removeEventListener('mousemove', onMove);
    window.removeEventListener('mouseup', onUp);
    fitAddon.fit();
    term.focus();
  };

  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
});

connect();
</script>
</body>
</html>
